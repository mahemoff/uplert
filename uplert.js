const r2 = require("r2");
const url = `https://api.up.com.au/api/v1/accounts/${process.env.UP_ACCOUNT_ID}`
let minBalance = 200;

//////////////////////////////////////////////////////////////////////////////
// GENERIC HTTP
//////////////////////////////////////////////////////////////////////////////

const httpGet = async (url, headers) => {
  try {
    const response = await r2(url, {headers}).json;
    return response.data;
  } catch (error) {
    console.log(error);
  }
};

//////////////////////////////////////////////////////////////////////////////
// GENERIC UPBANK APIs
//////////////////////////////////////////////////////////////////////////////

const getUp = async (path) => {
  const url = `https://api.up.com.au/api/v1/${path}`
  const data = await httpGet(url, {'Authorization': process.env.UP_KEY});
  return data;
};

const getUpAccount = async (id) => {
  const account = await getUp(`/accounts/${id}`);
  return account;
}

//////////////////////////////////////////////////////////////////////////////
// PAYMENTS
//////////////////////////////////////////////////////////////////////////////

const alertLowBalance = async () => {
  const account = await getUpAccount(process.env.UP_ACCOUNT_ID);
  let balance = account.attributes.balance.value;
  console.log ( `Balance ${(balance < minBalance) ? 'low!' : 'OK'}` );
}

//////////////////////////////////////////////////////////////////////////////
// RUN FROM COMMAND-LINE
//////////////////////////////////////////////////////////////////////////////

alertLowBalance();
